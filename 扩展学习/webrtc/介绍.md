## Webrtc

WebRTC 全称为：**Web Real-Time Communication**)

它是为了解决 Web 端无法捕获音视频的能力，并且提供了 peer-to-peer（就是浏览器间）的视频交互。

WebRTC汇集了先进的实时通信技术，包括：先进的音视频编解码器（Opus和VP8/9），强制加密协议（SRTP和DTLS）和网络地址转换器（ICE＆STUN）。

自成立以来，WebRTC已经大大降低了Web开发人员通过简单的Java API构建实时通信应用程序的难度。
但要清楚，**WebRTC是一种技术，而不是一个完整的应用程序或服务**。

目前来看，WebRTC在电视会议和直播领域有很大的潜力。





信令服务器的作用

```

```

![image-20210818102036440](/Users/apple/Library/Application Support/typora-user-images/image-20210818102036440.png)





P2P与P2S

WebRTC旨在通过其浏览器（也称为P2P）在客户端之间直接发送媒体流。在P2P架构中，客户端建立通信之前，首先需要建立到应用服务器（有时也称为信令服务器）的信令连接。而 WebRTC规范中没有规定信令方法或协议，它允许采用现有方法（SIP，WebSockets，XMPP等）或实现专有信令过程。应用服务器保存业务逻辑，并作为会话描述协议（SDP）交换的中介。一旦SDP交换完成，两个客户端之间的直接媒体通信即可开始。

虽然WebRTC主要是浏览器到浏览器，但是随着服务器将媒体锚定在网络中以充当媒体P2S（如下图）。在P2S架构中，客户端再次建立到应用服务器的信令连接。在该体系结构中，应用服务器继续管理业务逻辑，而且还利用到服务器的媒体控制连接来进行客户端和媒体服务器之间的SDP交换。一旦SDP交换完成，客户端和服务器之间的媒体通信即可开始。

使用服务器端处理可以引入高级功能，例如用于合规性的集中审查，音频/视频回放，用于视频流的媒体分析，从而实现人脸监测、人脸识别等。根据架构，服务器端处理可以优化带宽并最大限度地减少客户端计算，从而能够使移动客户延长电池使用时间，并为其提供灵活的用户界面。

从微观角度来看

WebRTC包含三个部分：

MediaStream:捕获音视频流
RTCPeerConnection:传输音视频流（一般用在 peer-to-peer 的场景）
RTCDataChannel: 用来上传音视频二进制数据（一般用到流的上传）
当然，PeerConnection也可以用于P2S的场景。


WebRTC 利用的是 UDP 方式来进行传输视频包。这样做的好处是延迟性低，不用过度关注包的顺序。不过，UDP 仅仅只是作为一个传输层协议而已。WebRTC 还需要解决很多问题：

遍历 NATs 层，找到指定的 peer

双方进行基本信息的协商以便双方都能正常播放视频

在传输时，还需要保证信息安全性
![image-20210818113807838](/Users/apple/Library/Application Support/typora-user-images/image-20210818113807838.png)



信令服务

WebRTC使用RTCPeerConnection来在浏览器之间传递流数据，在建立RTCPeerConnection实例之后，想要使用其建立一个点对点的信道，我们需要做两件事：

确定本机上的媒体流的特性，比如分辨率、编解码能力啥的（SDP描述符）
连接两端的主机的网络地址（ICE Candidate）
注：由于连接两端的主机都可能在内网或是在防火墙之后，我们需要一种对所有联网的计算机都通用的定位方式。这其中就涉及NAT/防火墙穿越技术。

实现上，就是两个点间的交互过程——通过offer和answer交接SDP描述符——我们称请求进行连接一端发出的信令为offer，另一端的回复称为answer。

模拟两个用户（甲和乙）之间建立点对点连接流程如下：

![image-20210818113840672](/Users/apple/Library/Application Support/typora-user-images/image-20210818113840672.png)

```

```

![image-20210818113852493](/Users/apple/Library/Application Support/typora-user-images/image-20210818113852493.png)





